<!doctype html>
<html lang="en" ng-app="angularChess" manifest="cache.manifest">
<head>
    <meta charset="utf-8">
    <title>Welcome to Chess Hub</title>
    <meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=0.5 maximum-scale=1.0">
    <link rel="stylesheet" media="all" href="css/app.css"/>
    <link rel="stylesheet" media="only screen and (max-width: 800px)" href="css/app_mobile.css"/>
  <script src="lib/jquery.js"></script>
    <script src="lib/angular/angular.js"></script>
    <script src="js/controllers.js"></script>
    <script src="js/filters.js"></script>
    <!--  <script src="js/app.js"></script>-->
    <!--  <script src="js/services.js"></script>-->
    <!--  <script src="js/directives.js"></script>-->
  <script>
    var user = window.location.href.substr(window.location.href.indexOf("=")+1);

    var counter = 0;
    var poll = function() {
        $.getJSON('/poll/'+counter, function(response) {
            counter = response.count;
            var output = $('#output');
            response.append.forEach( 
                function(message) { output.text(output.text() + message.time + " " + message.user + " : " + message.msg + "\n" );}
            );
            output.scrollTop = output.scrollHeight;
            poll();
        });
    }
    poll();

    function sendMessage(text) {
            var data = { user: user, msg: text } ;
            var output = $('#output');
            $.ajax({
                type: 'POST',
                url : '/msg',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: JSON.stringify(data),
                success: function() {$('#input').val('');},
                error: function() { output.text(output.text() + "Error connecting you to the server :(\n"); }
             });
    }

  </script>
</head>
<body ng-controller="GlobalCtrl">
    <div id="maincontainer">
          <div id="contentwrapper">
              <div id="chessBoardColumn">
                      <table class="chessBoard">
                        <tr ng-repeat="y in chessBoardRows" class="chessBoardRow">
                            <td ng-repeat="x in [1, 2, 3, 4, 5, 6, 7, 8]" 
                                    title="{{chessBoardColumns[x]}}{{y}}" 
                                    id="sq{{x}}{{y}}" 
                                    class="chessBoardSquare chessBoardSquare{{(y+x)%2}}" 
                                    ondrop="handleDrop(event)" 
                                    ondragover="handleDragOver(event)" 
                                    ondragleave="handleDragLeave(event)" 
                                    ondragenter="handleDragEnter(event)">
                            </td>
                        </tr>
                      </table>
                      <input type="button" value="init chessboard" id="initButton" ng-click="initChessBoard()">
              </div>
          </div>
          <div id='graveyards'>
                  <div id='wGraveyard'>
                        <img ng-repeat="piece in pieces | isColor:'white'"
                                class="piece {{piece.class}}" 
                                src="img/transparent.png" 
                                alt="{{piece.name}}" 
                                title="{{piece.name}}"
                                id="{{piece.id}}"
                                draggable="true"
                                ondragstart="handleDragStart(event)">
                          </img>
                  </div>
                  <div id='bGraveyard'>
                        <img ng-repeat="piece in pieces | isColor:'black'" 
                                class="piece {{piece.class}}" 
                                src="img/transparent.png" 
                                alt="{{piece.name}}" 
                                title="{{piece.name}}" 
                                id="{{piece.id}}" 
                                draggable="true" 
                                ondragstart="handleDragStart(event)">
                          </img>
                  </div>
          </div>
    <input type='text' id="input" style="width: 100%;" onkeypress="{if (event.keyCode==13) sendMessage(this.value)}">
    <textarea id="output" style="width: 100%; height: 100%;"></textarea>
    </div>

</body>
</html>
