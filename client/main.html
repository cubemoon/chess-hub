<!doctype html>
<html lang="en" manifest="cache.manifest">
<head>
    <meta charset="utf-8">
    <title>Chess Hub - The attic</title>
    <meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=0.5 maximum-scale=1.0">
    <link rel="stylesheet" media="all" href="css/app.css"/>
    <link rel="stylesheet" media="only screen and (max-width: 800px)" href="css/app_mobile.css"/>
  <script src="lib/jquery.js"></script>
  <script>
    var user = window.location.href.substr(window.location.href.indexOf("=")+1);

    var counter = 0;
    var poll = function() {
        $.getJSON('/poll/'+counter, function(response) {
            counter = response.count;
            if(response.append[0]) {  // to be replaced with a better test : is "append" an array of objects, or an object ? works for now.
                response.append.forEach(function(message) { addMessage(message); });
            } else {
                addMessage(response.append);
            }
            poll();
        });
    }
    poll();

    function addMessage(message) {
        // adds a message to the chat_output div of the current page
        var output = $('#output');
        console.log(message);
        output.html(
            output.html()
            + '<p class="'
            + message.category
            + '"><span class="chat_time">'
            + message.time
            + '</span><span class="chat_user">'
            + message.user
            + '</span><span class="chat_msg">'
            + message.msg
            + '</span></p>' );
    }
    
    function sendMessage(text) {
        if (!text) return;
        var data = { user: user, msg: text } ;
        var output = $('#output');
        $.ajax({
            type: 'POST',
            url : '/msg',
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            data: JSON.stringify(data),
            success: function() {$('#input').val('');},
            error: function() { output.text(output.text() + "Error connecting you to the server :(\n"); }
         });
    }

  </script>
</head>
<body>
    <div id="maincontainer">
          <div id="contentwrapper">
              <div id="chessBoardColumn">
              </div>
          </div>
          <div id='graveyards'>
                  <div id='wGraveyard'>
                  </div>
                  <div id='bGraveyard'>
                  </div>
          </div>
    <input type='text' id="input" class="chat_input" style="width: 100%;" onkeypress="{if (event.keyCode==13) sendMessage(this.value)}">
    <div id="output" class="chat_output" style="width: 100%; height: 100%;"></textarea>
    </div>

</body>
</html>
