<!doctype html>
<html lang="en" manifest="">
<head>
    <meta charset="utf-8">
    <title>Welcome to Chess Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="lib/jquery/jquery.mobile-1.3.0.min.css"></link>
    <link rel="stylesheet" href="css/common.css"></link>
    <link rel="stylesheet" href="css/main_layout.css"></link>
    <script src="js/chessHubClient-0.1.js"></script>
    <script src="lib/jquery/jquery-1.9.1.js"></script>
    <script src="lib/jquery/jquery.mobile-1.3.0.min.js"></script>
  <script>

    ;CONTEXT = {
        credentials: {
            user:"",
            key:""
        }
    };

    if ( ! window.console ) console = { log: function(){} };
    
    $(document).ready(function() {
        $("#login_submit").click(function(event) {
                event.preventDefault();
                connect($("#login_username").val());
        });
    });
    
    function connect(user) {
        $.mobile.loading('show');
        CHESSHUB.connect(user,
                function(response) {                    // callback function for success event
                    $('#login_returnmessage').text(response.returnmessage); // display returned message, be it "welcome" or "keep out"
                    $.mobile.loading('hide');
                    if(response.returncode == 'ok'){    // user is connected; start polling for messaging and switch to main page
                        CONTEXT.user = response.user;
                        CONTEXT.key = response.key;
                        console.log(CONTEXT.user + ' connected; key : ' + CONTEXT.key);
                        CHESSHUB.listen(CONTEXT, 'MAIN');
                        $.mobile.changePage($("#mainpage"));
                    }
				},
                function(error) {                       // callback function for error event
                    $.mobile.loading('hide');
                    $('#login_returnmessage').text("Error connecting you to the server :(");
                }
        );
    }
    
    function addMessage(message) {
        // adds a message to the chat_output div of the current page
        var output = $('#chat_output');
        console.log(message);
        if (message.category == "chat_sys") {
            output.html(
                '<p class="chat_sys">'
                + message.user + " > "
                + message.msg
                + '</p>'
                + output.html() );
        } else {
            output.html(
                '<p class="'
                + message.category
                + '"><span class="chat_time">'
                + message.time
                + '</span><span class="chat_user">'
                + message.user + " > "
                + '</span><span class="chat_msg">'
                + message.msg
                + '</span></p>'
                + output.html() );
        }
    }

    function sendMessage(text) {
        // sends a message on the main channel
        if (!text) return;
        var output = $('#chat_output');
        CHESSHUB.sendMessage(
                CONTEXT,
                text,
                function(){
                    $('#chat_input').val('');
                    console.log('message sent');
                },
                function(){
                    output.html("<p class='chat_sys'>Error connecting you to the server :(</p>" + output.html());
                }
        );
    }

  </script>
</head>
<body>

<!--############### Login Page ###############-->
<div data-role="page" id="loginpage"> <!-- identification -->
    <header data-role="header">
		<h1>Login</h1>
	</header>
        <h2>Please enter a username</h2>
        <input type='text' id="login_username" onkeypress="{if (event.keyCode==13 && this.value !== '') connect(this.value)}">
        <span class="info" id="login_returnmessage"></span>
        <button id="login_submit" type="submit" data-theme="a">Submit</button>
</div>


<!--############### Main Page ###############-->
<div data-role="page" id="mainpage">
    <header data-role="header">
        <h1>Chess Hub lobby</h1>
		<a href="#loginpage" data-icon="delete" data-iconpos="notext">Exit</a>
		<a href="#configpage" data-icon="gear" data-iconpos="notext">Configuration</a>
	</header>
    <div id="mainpage_side">
	    <form method="POST" action="" data-ajax="false">
            <div data-role="fieldcontain">
                <fieldset data-role="controlgroup">
                    <legend>Your self-estimated skill:</legend>
                    <input type="radio" name="game_user_level" id="game_user_level_GM">
                    <label for="game_user_level_GM">Grand Master</label>
                    <input type="radio" name="game_user_level" id="game_user_level_M">
                    <label for="game_user_level_M">Medium</label>
                    <input type="radio" name="game_user_level" id="game_user_level_B">
                    <label for="game_user_level_B">Beginner</label>
                    <label for="game_lower_ok">Allow lower level opponents ?</label>
                        <select name="game_lower_ok" id="game_lower_ok" data-role="slider">
                            <option value="on">Yes</option>
                            <option value="off">No</option>
                        </select>                
                    <label for="game_lower_ok">Allow higher level opponents ?</label>
                        <select name="game_higher_ok" id="game_higher_ok" data-role="slider">
                            <option value="on">Yes</option>
                            <option value="off">No</option>
                        </select>                
                    </fieldset>
    		    <button id="game_search" type="submit" data-theme="a">search</button>
		    </div>
	    </form>	
    </div>
    <div id="mainpage_main">
        <input type='text' id="chat_input" onkeypress="{if (event.keyCode==13) sendMessage(this.value)}">
        <div id="chat_output"></div>
    </div>
</div>

</body>
</html>
